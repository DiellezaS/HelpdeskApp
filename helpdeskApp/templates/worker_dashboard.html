<!DOCTYPE html>
<html>
<head>
    <title>Worker Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
            color: #2d3436;
            font-size: 16px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        h2 {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        h3 {
            color: #2c3e50;
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 20px;
        }

        section {
            margin-bottom: 40px;
        }

        button, .btn {
            background: #3498db;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        button:hover, .btn:hover {
            background: #2980b9;
        }

        button:focus, input:focus, textarea:focus, select:focus, a:focus {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        ul li {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        ul li:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        ul li strong {
            font-size: 16px;
            color: #2c3e50;
        }

        ul li a {
            display: inline-block;
            margin-top: 5px;
            font-size: 14px;
            color: #2980b9;
        }

        ul li a:hover {
            text-decoration: underline;
        }

        #faqChatbotModal {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            max-height: 80vh;
            background: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            overflow-y: auto;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(20px);
        }

        #faqChatbotModal.show {
            opacity: 1;
            transform: translateY(0);
        }

        #faqChatbotModal h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #2c3e50;
        }

        #faqChatbotModal .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #7f8c8d;
        }

        #faqChatbotModal .close-btn:hover {
            color: #2c3e50;
        }

        #faqQuestions button {
            background: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
            width: 100%;
            text-align: left;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        #faqQuestions button:hover {
            background: #dfe6e9;
        }

        #faqQuestions button:disabled {
            background: #f5f6fa;
            color: #b2bec3;
            cursor: not-allowed;
        }

        #faqAnswer {
            margin-top: 10px;
            font-weight: semibold;
            color: rgb(241, 110, 53);
        }

        #questionForm {
            margin-top: 20px;
        }

        #questionInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #dfe6e9;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        #questionInput:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        #submitQuestion {
            width: 100%;
            padding: 12px;
            background: #3498db;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        #submitQuestion:hover {
            background: #2980b9;
        }

        #response {
            margin-top: 15px;
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }

        #response.show {
            display: block;
        }

        #response.answer {
            background: #e0f7fa;
            color: rgb(120, 219, 207);
            border-left: 4px solid #00796b;
        }

        #response.ticket {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #856404;
        }

        #response.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #721c24;
        }

        form {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        form input,
        form textarea,
        form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #dfe6e9;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        form input:focus,
        form textarea:focus,
        form select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        form button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: #3498db;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        form button[type="submit"]:hover {
            background: #2980b9;
        }

        .message {
            background: #e0f7fa;
            color: #00796b;
            padding: 12px;
            border-left: 4px solid #00796b;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        a {
            color: #2980b9;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .filter-form {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .filter-form label {
            font-weight: bold;
            color: #2c3e50;
            margin-right: 10px;
        }

        .filter-form select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            color: #333;
            background-color: #fff;
            cursor: pointer;
        }

        .filter-form select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        @media (max-width: 600px) {
            .container {
                padding: 0 10px;
            }

            #faqChatbotModal {
                width: 90%;
                right: 5%;
                bottom: 10px;
            }

            form {
                padding: 15px;
            }

            button, .btn {
                padding: 8px 12px;
            }

            .filter-form {
                padding: 10px;
            }

            .filter-form select {
                width: 100%;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <section>
            <h3>Worker Dashboard</h3>
            <h2>Welcome {{ user.username }}!</h2>
            <button class="btn" onclick="openFAQChat()">Open FAQ Chatbot</button>
        </section>

        <div>
            <form method="get" class="filter-form">
                {% csrf_token %}
                <label for="status_filter">Filter by Status:</label>
                <select name="status" id="status_filter" onchange="this.form.submit()">
                    <option value="">All</option>
                    <option value="open" {% if request.GET.status == 'open' %}selected{% endif %}>Open</option>
                    <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="resolved" {% if request.GET.status == 'resolved' %}selected{% endif %}>Resolved</option>
                    <option value="closed" {% if request.GET.status == 'closed' %}selected{% endif %}>Closed</option>
                </select>
            </form>
        <div>

        <!-- FAQ Chatbot Modal -->
        <div id="faqChatbotModal" role="dialog" aria-labelledby="faqModalTitle" style="display:none;">
            <button class="close-btn" onclick="closeFAQChat()" aria-label="Close FAQ Chatbot">Ã—</button>
            <h3 id="faqModalTitle">Hello!</h3>
            <p>Pick one of the questions below:</p>
            <ul id="faqQuestions">
                <li><button onclick="selectQuestion(0)">What is the password policy?</button></li>
                <li><button onclick="selectQuestion(1)">How to reset my password?</button></li>
                <li><button onclick="selectQuestion(2)">Where can I see my tickets?</button></li>
                <li><button onclick="selectQuestion(3)">How long does a ticket take?</button></li>
                <li><button onclick="selectQuestion(4)">What if I forgot my username?</button></li>
            </ul>
            <div id="faqAnswer"></div>
            <form id="questionForm">
                <h2>FAQ</h2>
                <textarea id="question" name="question" placeholder="Type your question" rows="4"></textarea>
                <button id="submitQuestion" type="submit" name="submit_question">Submit Question</button>
                <div id="answer"></div>
            </form>
        </div>

        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="message">{{ message }}</div>
            {% endfor %}
        {% endif %}

        <!-- Answer -->
        {% if answer %}
            <div class="message">{{ answer }}</div>
        {% endif %}

        <!-- Ticket List -->
        <section id="ticket-list">
            <h2>Your Tickets</h2>
            <ul>
                {% for ticket in tickets %}
                    <li>
                        <strong>{{ ticket.subject }}</strong> - Status: {{ ticket.status }}<br>
                        <a href="{% url 'ticket_detail' ticket.id %}">See and add comment</a>
                    </li>
                {% empty %}
                    <li>You don't have any tickets.</li>
                {% endfor %}
            </ul>
        </section>

        <!-- Create Ticket Form -->
        <section id="create-ticket">
            <h2>Create a Ticket</h2>
            <form method="post">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" name="submit_ticket">Submit Ticket</button>
            </form>
        </section>

        <a href="{% url 'logout' %}">Logout</a>
    </div>

    <script>
        const faqPairs = [
            { question: "What is the password policy?", answer: "Your password must contain at least 8 characters, including uppercase and numbers." },
            { question: "How to reset my password?", answer: "Click on 'Forgot Password' at login and follow the instructions." },
            { question: "Where can I see my tickets?", answer: "You can see your tickets listed in the 'Your Tickets' section of the dashboard." },
            { question: "How long does a ticket take?", answer: "Tickets are usually resolved within 24-48 hours depending on priority." },
            { question: "What if I forgot my username?", answer: "Contact your system administrator or submit a helpdesk ticket." }
        ];

        let answeredCount = 0;

        function openFAQChat() {
            const modal = document.getElementById("faqChatbotModal");
            modal.style.display = "block";
            setTimeout(() => modal.classList.add("show"), 10);
        }

        function closeFAQChat() {
            const modal = document.getElementById("faqChatbotModal");
            modal.classList.remove("show");
            setTimeout(() => {
                modal.style.display = "none";
                document.getElementById("faqAnswer").innerHTML = "";
                document.getElementById("answer").innerHTML = "";
                document.getElementById("answer").className = "";
                answeredCount = 0;
            }, 300);
        }

        function selectQuestion(index) {
            const answerDiv = document.getElementById("faqAnswer");
            answerDiv.innerHTML = `<strong>${faqPairs[index].answer}</strong>`;
            answeredCount++;

            const buttons = document.querySelectorAll("#faqQuestions button");
            buttons[index].disabled = true;

            if (answeredCount >= faqPairs.length) {
                setTimeout(() => {
                    answerDiv.innerHTML = "You have viewed all FAQs. Now you can create a ticket below.";
                    document.getElementById("create-ticket").scrollIntoView({ behavior: "smooth" });
                }, 1500);
            }
        }

        document.getElementById("questionForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const questionInput = document.getElementById("question").value.trim();
            const responseDiv = document.getElementById("answer");

            if (!questionInput) {
                responseDiv.textContent = "Please enter a question.";
                responseDiv.className = "error show";
                return;
            }

            try {
                const formData = new FormData();
                formData.append("question", questionInput);
                formData.append("submit_question", "true");
                formData.append("csrfmiddlewaretoken", "{{ csrf_token }}");

                const response = await fetch("/worker/", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    }
                });

                const data = await response.json();

                if (data.status === "answered") {
                    responseDiv.textContent = `Answer: ${data.answer}`;
                    responseDiv.className = "answer show";
                } else if (data.status === "ticket_created") {
                    responseDiv.textContent = `No answer found. A ticket has been created for your question: "${questionInput}". Our team will respond soon.`;
                    responseDiv.className = "ticket show";
                } else {
                    responseDiv.textContent = "An error occurred. Please try again later.";
                    responseDiv.className = "error show";
                }
            } catch (error) {
                console.error("Error:", error);
                responseDiv.textContent = "An error occurred while processing your request.";
                responseDiv.className = "error show";
            }

            document.getElementById("question").value = "";
        });
    </script>
</body>
</html>